<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Airsoft Arena</title>
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      background: #000;
    }
    canvas {
      display: block;
    }
    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-family: sans-serif;
      z-index: 10;
    }
    #crosshair {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 6px;
      height: 6px;
      background: white;
      transform: translate(-50%, -50%);
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="hud">
    Health: <span id="healthText">100</span>
  </div>
  <div id="crosshair"></div>
  <canvas id="gameCanvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/three@0.125.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.125.2/examples/js/controls/PointerLockControls.js"></script>
  <script>
    let camera, scene, renderer, controls, clock;
    let bullets = [], enemies = [], obstacles = [];
    let health = 100;
    let keys = {};
    const canvas = document.getElementById('gameCanvas');
    const healthText = document.getElementById('healthText');

    init();
    animate();

    function init() {
      clock = new THREE.Clock();
      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 1.6, 0);

      renderer = new THREE.WebGLRenderer({ canvas });
      renderer.setSize(window.innerWidth, window.innerHeight);

      // Lighting
      const ambient = new THREE.AmbientLight(0xffffff, 0.6);
      const directional = new THREE.DirectionalLight(0xffffff, 0.6);
      directional.position.set(10, 20, 0);
      scene.add(ambient, directional);

      // Floor
      const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(500, 500),
        new THREE.MeshStandardMaterial({ color: 0x228822 })
      );
      floor.rotation.x = -Math.PI / 2;
      scene.add(floor);

      // Controls
      controls = new THREE.PointerLockControls(camera, document.body);
      scene.add(controls.getObject());

      document.body.addEventListener('click', () => {
        if (!controls.isLocked) controls.lock();
      });

      // Add obstacles
      createAirsoftField();

      // Gun model
      const gunGeometry = new THREE.BoxGeometry(0.2, 0.1, 0.6);
      const gunMaterial = new THREE.MeshStandardMaterial({ color: 0x333333 });
      const gun = new THREE.Mesh(gunGeometry, gunMaterial);
      gun.position.set(0.3, -0.2, -0.6);
      camera.add(gun);

      // Enemies
      for (let i = 0; i < 5; i++) spawnEnemy();

      // Controls
      window.addEventListener('keydown', (e) => keys[e.code] = true);
      window.addEventListener('keyup', (e) => keys[e.code] = false);
      document.addEventListener('mousedown', shoot);
    }

    function createAirsoftField() {
      const wallMat = new THREE.MeshStandardMaterial({ color: 0xaaaaaa });
      const houseMat = new THREE.MeshStandardMaterial({ color: 0x6666cc });

      // Barriers
      for (let i = 0; i < 40; i++) {
        const barrier = new THREE.Mesh(
          new THREE.BoxGeometry(4, 2, 1),
          wallMat
        );
        barrier.position.set(
          Math.random() * 400 - 200,
          1,
          Math.random() * 400 - 200
        );
        scene.add(barrier);
        obstacles.push(barrier);
      }

      // Houses
      for (let i = 0; i < 10; i++) {
        const baseX = Math.random() * 400 - 200;
        const baseZ = Math.random() * 400 - 200;

        // Walls
        const wall1 = new THREE.Mesh(new THREE.BoxGeometry(10, 3, 0.5), houseMat);
        wall1.position.set(baseX, 1.5, baseZ - 5);
        scene.add(wall1); obstacles.push(wall1);

        const wall2 = new THREE.Mesh(new THREE.BoxGeometry(0.5, 3, 10), houseMat);
        wall2.position.set(baseX - 5, 1.5, baseZ);
        scene.add(wall2); obstacles.push(wall2);

        const wall3 = new THREE.Mesh(new THREE.BoxGeometry(10, 3, 0.5), houseMat);
        wall3.position.set(baseX, 1.5, baseZ + 5);
        scene.add(wall3); obstacles.push(wall3);

        const wall4 = new THREE.Mesh(new THREE.BoxGeometry(0.5, 3, 10), houseMat);
        wall4.position.set(baseX + 5, 1.5, baseZ);
        scene.add(wall4); obstacles.push(wall4);

        // Windows
        const windowMat = new THREE.MeshStandardMaterial({ color: 0x99ccff });
        const window = new THREE.Mesh(new THREE.BoxGeometry(2, 1, 0.1), windowMat);
        window.position.set(baseX, 1.5, baseZ - 5);
        scene.add(window);
      }
    }

    function spawnEnemy() {
      const enemy = new THREE.Mesh(
        new THREE.BoxGeometry(1, 2, 1),
        new THREE.MeshStandardMaterial({ color: 0xff0000 })
      );
      enemy.position.set(Math.random() * 400 - 200, 1, Math.random() * 400 - 200);
      enemy.health = 100;
      scene.add(enemy);
      enemies.push(enemy);
    }

    function shoot() {
      if (!controls.isLocked) return;

      const bullet = new THREE.Mesh(
        new THREE.SphereGeometry(0.1, 8, 8),
        new THREE.MeshStandardMaterial({ color: 0xffff00 })
      );
      bullet.position.copy(camera.position);
      const direction = new THREE.Vector3();
      camera.getWorldDirection(direction);
      bullet.userData.velocity = direction.clone().multiplyScalar(2);
      scene.add(bullet);
      bullets.push(bullet);
    }

    function animate() {
      requestAnimationFrame(animate);
      const delta = clock.getDelta();

      // Movement
      if (controls.isLocked) {
        const speed = 10 * delta;
        if (keys['KeyW']) controls.moveForward(speed);
        if (keys['KeyS']) controls.moveForward(-speed);
        if (keys['KeyA']) controls.moveRight(-speed);
        if (keys['KeyD']) controls.moveRight(speed);
      }

      // Bullet logic
      bullets.forEach((bullet, i) => {
        bullet.position.add(bullet.userData.velocity);

        if (bullet.position.length() > 500) {
          scene.remove(bullet);
          bullets.splice(i, 1);
          return;
        }

        enemies.forEach((enemy, j) => {
          if (bullet.position.distanceTo(enemy.position) < 1) {
            enemy.health -= 50;
            if (enemy.health <= 0) {
              scene.remove(enemy);
              enemies.splice(j, 1);
              setTimeout(spawnEnemy, 3000);
            }
            scene.remove(bullet);
            bullets.splice(i, 1);
          }
        });
      });

      // Enemy AI
      enemies.forEach(enemy => {
        const dir = new THREE.Vector3().subVectors(camera.position, enemy.position);
        if (dir.length() < 100) {
          dir.normalize().multiplyScalar(0.5 * delta);
          enemy.position.add(dir);
        }

        if (dir.length() < 2 && Math.random() < 0.01) {
          health -= 5;
          healthText.textContent = health;
          if (health <= 0) {
            alert("You Died!");
            location.reload();
          }
        }
      });

      renderer.render(scene, camera);
    }
  </script>
</body>
</html>
