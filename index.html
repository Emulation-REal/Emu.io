<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emu.io</title>
<style>
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0;
    height: 100%;
    background: #121212;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #eee;
    overflow: hidden;
  }
  #mainMenu {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: linear-gradient(135deg, #1a1a1a, #222);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 30px;
    z-index: 1000;
  }
  #mainMenu h1 {
    font-size: 4rem;
    letter-spacing: 6px;
    margin: 0;
    color: #ff5555;
    text-shadow: 0 0 10px #ff4444;
  }
  .btn {
    background: #333;
    border: 2px solid #ff5555;
    padding: 15px 30px;
    font-size: 1.5rem;
    cursor: pointer;
    border-radius: 10px;
    transition: background 0.3s, color 0.3s;
    user-select: none;
    min-width: 200px;
  }
  .btn:hover {
    background: #ff4444;
    color: #fff;
  }
  #mapSelect {
    display: flex;
    gap: 20px;
  }
  #mapSelect .btn {
    min-width: 120px;
    font-size: 1.2rem;
  }
  #gameUI {
    position: absolute;
    top: 10px;
    left: 10px;
    width: 220px;
    user-select: none;
    z-index: 900;
  }
  #healthBarContainer {
    width: 100%;
    height: 30px;
    background: #440000;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 0 10px #660000;
  }
  #healthBar {
    height: 100%;
    background: #ff2222;
    width: 100%;
    transition: width 0.3s ease;
  }
  #healthText {
    margin-top: 4px;
    font-size: 1.2rem;
    text-align: center;
    font-weight: bold;
    color: #ffcccc;
    text-shadow: 0 0 3px #660000;
  }
  #pauseMenu {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 30px;
    z-index: 1100;
  }
  #pauseMenu.active {
    display: flex;
  }
  #pauseMenu h2 {
    font-size: 3rem;
    color: #ff5555;
    text-shadow: 0 0 10px #ff4444;
    margin: 0;
  }
  canvas {
    display: block;
    margin: 0 auto;
    background: #222;
    border-radius: 10px;
  }
</style>
</head>
<body>

<!-- Main Menu -->
<div id="mainMenu" class="active">
  <h1>Emu.io</h1>
  <div id="mapSelect">
    <button class="btn" data-map="0">Arena</button>
    <button class="btn" data-map="1">Desert</button>
    <button class="btn" data-map="2">Snow</button>
  </div>
</div>

<!-- Game UI -->
<div id="gameUI" style="display:none;">
  <div id="healthBarContainer">
    <div id="healthBar"></div>
  </div>
  <div id="healthText">Health: 100</div>
</div>

<!-- Pause Menu -->
<div id="pauseMenu">
  <h2>Paused</h2>
  <button class="btn" id="resumeBtn">Resume</button>
  <button class="btn" id="mainMenuBtn">Main Menu</button>
</div>

<!-- Canvas -->
<canvas id="gameCanvas" width="960" height="540" tabindex="0"></canvas>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/controls/PointerLockControls.js"></script>

<script>
(() => {
  const canvas = document.getElementById('gameCanvas');
  const healthBar = document.getElementById('healthBar');
  const healthText = document.getElementById('healthText');
  const mainMenu = document.getElementById('mainMenu');
  const pauseMenu = document.getElementById('pauseMenu');
  const resumeBtn = document.getElementById('resumeBtn');
  const mainMenuBtn = document.getElementById('mainMenuBtn');
  const mapButtons = document.querySelectorAll('#mapSelect .btn');
  const gameUI = document.getElementById('gameUI');

  let scene, camera, renderer, controls;
  let player, playerVelocity = new THREE.Vector3();
  let enemies = [];
  let bullets = [];
  let enemyBullets = [];
  let clock = new THREE.Clock();
  let keys = {};
  let health = 100;
  let isPaused = false;
  let currentMap = null;

  // Maps definition
  const maps = [
    {
      name: 'Arena',
      size: 60,
      color: 0x303030
    },
    {
      name: 'Desert',
      size: 100,
      color: 0x8B7E66
    },
    {
      name: 'Snow',
      size: 80,
      color: 0xBFE3F8
    }
  ];

  // --- Initialize scene & player ---
  function init(mapIndex) {
    // Cleanup if restarting
    if(renderer) {
      renderer.dispose();
      renderer.domElement.remove();
      scene = null;
      camera = null;
      controls = null;
      enemies = [];
      bullets = [];
      enemyBullets = [];
    }

    scene = new THREE.Scene();

    currentMap = maps[mapIndex] || maps[0];

    // Floor
    const floorGeometry = new THREE.PlaneGeometry(currentMap.size, currentMap.size);
    const floorMaterial = new THREE.MeshPhongMaterial({ color: currentMap.color });
    const floor = new THREE.Mesh(floorGeometry, floorMaterial);
    floor.rotation.x = -Math.PI / 2;
    floor.receiveShadow = true;
    scene.add(floor);

    // Lights
    const ambientLight = new THREE.AmbientLight(0xaaaaaa);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(20, 40, 20);
    directionalLight.castShadow = true;
    scene.add(directionalLight);

    // Player camera and controls
    camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
    controls = new THREE.PointerLockControls(camera, document.body);

    // Add player object for collision detection (invisible)
    player = new THREE.Object3D();
    player.position.set(0, 1.5, 0);
    scene.add(player);

    camera.position.set(0, 1.5, 0);
    player.add(camera);

    // Renderer setup
    if(!renderer) {
      renderer = new THREE.WebGLRenderer({ canvas });
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      renderer.shadowMap.enabled = true;
    }

    // Setup event listeners for pointer lock
    canvas.onclick = () => {
      if (!controls.isLocked) {
        controls.lock();
      }
    };

    controls.addEventListener('lock', () => {
      console.log('Pointer locked');
      canvas.style.cursor = 'none';
    });

    controls.addEventListener('unlock', () => {
      console.log('Pointer unlocked');
      canvas.style.cursor = 'default';
      pauseGame();
    });

    // Spawn enemies
    spawnEnemies(12);

    health = 100;
    updateHealthUI();

    gameUI.style.display = 'block';

    animate();

    canvas.focus();
  }

  // --- Spawn enemies ---
  function spawnEnemies(amount) {
    for(let i = 0; i < amount; i++) {
      const enemy = createEnemy();
      enemies.push(enemy);
      scene.add(enemy.mesh);
    }
  }

  // --- Enemy factory ---
  function createEnemy() {
    const geometry = new THREE.BoxGeometry(1, 2, 1);
    const material = new THREE.MeshPhongMaterial({ color: 0x222222 });
    const mesh = new THREE.Mesh(geometry, material);
    mesh.castShadow = true;
    mesh.position.set(
      (Math.random() - 0.5) * currentMap.size * 0.8,
      1,
      (Math.random() - 0.5) * currentMap.size * 0.8
    );
    return {
      mesh,
      health: 50,
      shootCooldown: Math.random() * 3 + 2, // seconds
      shootTimer: 0,
      speed: 2,
      shoot() {
        if (!controls.isLocked) return; // Don't shoot if player not focused
        if (this.shootTimer <= 0) {
          if (Math.random() < 0.5) { // 50% chance to shoot
            const bullet = createBullet(this.mesh.position, player.position, false);
            enemyBullets.push(bullet);
            scene.add(bullet.mesh);
            this.shootTimer = this.shootCooldown;
          }
        }
      },
      update(delta) {
        // Simple AI: move towards player slowly
        const dir = new THREE.Vector3().subVectors(player.position, this.mesh.position);
        dir.y = 0;
        if (dir.length() > 2) {
          dir.normalize();
          this.mesh.position.addScaledVector(dir, this.speed * delta);
        }
        // Shoot logic
        this.shootTimer -= delta;
        this.shoot();
      }
    };
  }

  // --- Bullet factory ---
  function createBullet(startPos, targetPos, isPlayerBullet = true) {
    const geometry = new THREE.SphereGeometry(0.1, 8, 8);
    const material = new THREE.MeshBasicMaterial({ color: isPlayerBullet ? 0xffff00 : 0xff0000 });
    const mesh = new THREE.Mesh(geometry, material);
    mesh.position.copy(startPos);

    const velocity = new THREE.Vector3().subVectors(targetPos, startPos).normalize().multiplyScalar(20);

    return {
      mesh,
      velocity,
      isPlayerBullet,
      lifeTime: 3, // seconds
      update(delta) {
        mesh.position.addScaledVector(this.velocity, delta);
        this.lifeTime -= delta;
      }
    };
  }

  // --- Keyboard Input ---
  window.addEventListener('keydown', (e) => {
    keys[e.code] = true;

    // Pause menu toggle
    if(e.code === 'Escape') {
      if (isPaused) {
        resumeGame();
      } else {
        pauseGame();
      }
    }
  });
  window.addEventListener('keyup', (e) => {
    keys[e.code] = false;
  });

  // --- Player movement ---
  function updatePlayer(delta) {
    if (!controls.isLocked) return;

    const speed = 8;
    const direction = new THREE.Vector3();
    if (keys['KeyW']) direction.z -= 1;
    if (keys['KeyS']) direction.z += 1;
    if (keys['KeyA']) direction.x -= 1;
    if (keys['KeyD']) direction.x += 1;

    if(direction.lengthSq() > 0) {
      direction.normalize();
      direction.applyEuler(camera.rotation);
      player.position.addScaledVector(direction, speed * delta);
    }
  }

  // --- Shooting ---
  let canShoot = true;
  window.addEventListener('mousedown', () => {
    if (!controls.isLocked || isPaused) return;
    if (canShoot) {
      shootBullet();
      canShoot = false;
      setTimeout(() => { canShoot = true; }, 300); // 0.3 sec cooldown
    }
  });

  function shootBullet() {
    const startPos = player.position.clone();
    startPos.y += 1.5; // gun height
    const direction = new THREE.Vector3(0, 0, -1).applyEuler(camera.rotation);
    const targetPos = startPos.clone().add(direction.multiplyScalar(100));
    const bullet = createBullet(startPos, targetPos, true);
    bullets.push(bullet);
    scene.add(bullet.mesh);
  }

  // --- Health UI update ---
  function updateHealthUI() {
    healthBar.style.width = (health) + '%';
    healthText.textContent = 'Health: ' + Math.floor(health);
  }

  // --- Game Loop ---
  function animate() {
    if (isPaused) {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
      return;
    }

    const delta = clock.getDelta();

    updatePlayer(delta);

    // Update enemies
    enemies.forEach(enemy => {
      enemy.update(delta);
    });

    // Update bullets
    bullets.forEach((b, i) => {
      b.update(delta);
      // Remove bullets past lifetime or far away
      if (b.lifeTime <= 0 || b.mesh.position.distanceTo(player.position) > 200) {
        scene.remove(b.mesh);
        bullets.splice(i, 1);
        return;
      }
      // Check collision with enemies (player bullets)
      if (b.isPlayerBullet) {
        enemies.forEach((enemy, idx) => {
          if (enemy.mesh.position.distanceTo(b.mesh.position) < 1) {
            enemy.health -= 20;
            scene.remove(b.mesh);
            bullets.splice(i,1);
            if(enemy.health <= 0) {
              scene.remove(enemy.mesh);
              enemies.splice(idx, 1);
            }
          }
        });
      }
    });

    // Update enemy bullets
    enemyBullets.forEach((b, i) => {
      b.update(delta);
      // Remove bullets past lifetime or far away
      if (b.lifeTime <= 0 || b.mesh.position.distanceTo(player.position) > 200) {
        scene.remove(b.mesh);
        enemyBullets.splice(i, 1);
        return;
      }
      // Check collision with player
      if (!b.isPlayerBullet) {
        if (b.mesh.position.distanceTo(player.position) < 1) {
          health -= 10;
          updateHealthUI();
          scene.remove(b.mesh);
          enemyBullets.splice(i, 1);
          if(health <= 0) {
            respawnPlayer();
          }
        }
      }
    });

    renderer.render(scene, camera);
    requestAnimationFrame(animate);
  }

  // --- Pause & Resume ---
  function pauseGame() {
    if (isPaused) return;
    isPaused = true;
    pauseMenu.classList.add('active');
    controls.unlock();
    canvas.style.cursor = 'default';
  }
  function resumeGame() {
    if (!isPaused) return;
    isPaused = false;
    pauseMenu.classList.remove('active');
    controls.lock();
    canvas.style.cursor = 'none';
  }

  resumeBtn.onclick = () => {
    resumeGame();
  };

  mainMenuBtn.onclick = () => {
    pauseMenu.classList.remove('active');
    gameUI.style.display = 'none';
    mainMenu.classList.add('active');
  };

  // --- Respawn player ---
  function respawnPlayer() {
    console.log('Player died. Respawning...');
    health = 100;
    updateHealthUI();
    // Reset player position
    player.position.set(0, 1.5, 0);
  }

  // --- Start Game ---
  function startGame(mapIndex) {
    console.log('Map selected:', mapIndex);
    mainMenu.classList.remove('active');
    gameUI.style.display = 'block';
    init(mapIndex);
    canvas.focus();
  }

  // --- Setup map buttons ---
  mapButtons.forEach(btn => {
    btn.onclick = () => {
      let mapIndex = Number(btn.getAttribute('data-map'));
      startGame(mapIndex);
    };
  });

  // Resize canvas & renderer on window resize
  function onWindowResize() {
    const w = window.innerWidth;
    const h = window.innerHeight;
    canvas.width = w;
    canvas.height = h;
    if(renderer) {
      renderer.setSize(w, h);
    }
    if(camera) {
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }
  }
  window.addEventListener('resize', onWindowResize);
  onWindowResize();

})();
</script>

</body>
</html>
