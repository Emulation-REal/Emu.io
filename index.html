<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Emu.io - Airsoft Field FPS</title>
  <style>
    html, body {
      margin: 0; padding: 0; overflow: hidden;
      height: 100%; background: #111;
    }
    canvas { display: block; }
    #crosshair {
      position: absolute;
      left: 50%; top: 50%;
      width: 4px; height: 4px;
      background: white;
      margin-left: -2px; margin-top: -2px;
      z-index: 10;
    }
  </style>
</head>
<body>
<div id="crosshair"></div>
<canvas id="gameCanvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/controls/PointerLockControls.js"></script>

<script>
  let scene, camera, renderer, controls, raycaster, clock;
  let bullets = [], enemies = [], obstacles = [];
  let health = 100, ammo = 10;
  let move = { forward: false, back: false, left: false, right: false };
  let velocity = new THREE.Vector3();

  const canvas = document.querySelector('#gameCanvas');
  init();
  animate();

  function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x222222);
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 1.6, 0);

    renderer = new THREE.WebGLRenderer({ canvas });
    renderer.setSize(window.innerWidth, window.innerHeight);

    clock = new THREE.Clock();
    raycaster = new THREE.Raycaster();

    // Lighting
    const ambient = new THREE.AmbientLight(0xcccccc);
    const light = new THREE.DirectionalLight(0xffffff, 0.8);
    light.position.set(10, 50, 10);
    scene.add(ambient, light);

    // Floor
    const floor = new THREE.Mesh(
      new THREE.PlaneGeometry(300, 300),
      new THREE.MeshStandardMaterial({ color: 0x333333 })
    );
    floor.rotation.x = -Math.PI / 2;
    scene.add(floor);

    // Controls
    controls = new THREE.PointerLockControls(camera, document.body);
    scene.add(controls.getObject());

    document.body.addEventListener('click', () => {
      controls.lock();
    });

    // Gun
    const gunGeometry = new THREE.BoxGeometry(0.2, 0.2, 0.6);
    const gunMaterial = new THREE.MeshStandardMaterial({ color: 0x3333ff });
    const gun = new THREE.Mesh(gunGeometry, gunMaterial);
    gun.position.set(0.3, -0.3, -0.7);
    camera.add(gun);

    // Houses
    generateField();

    // Enemies
    for (let i = 0; i < 5; i++) spawnEnemy();

    // Events
    document.addEventListener('keydown', e => {
      if (e.code === 'KeyW') move.forward = true;
      if (e.code === 'KeyS') move.back = true;
      if (e.code === 'KeyA') move.left = true;
      if (e.code === 'KeyD') move.right = true;
      if (e.code === 'Space') shoot();
    });

    document.addEventListener('keyup', e => {
      if (e.code === 'KeyW') move.forward = false;
      if (e.code === 'KeyS') move.back = false;
      if (e.code === 'KeyA') move.left = false;
      if (e.code === 'KeyD') move.right = false;
    });
  }

  function generateField() {
    const wallMat = new THREE.MeshStandardMaterial({ color: 0xaaaaaa });
    const windowMat = new THREE.MeshStandardMaterial({ color: 0x9999ff, transparent: true, opacity: 0.4 });

    for (let i = 0; i < 10; i++) {
      const x = Math.random() * 200 - 100;
      const z = Math.random() * 200 - 100;

      // Walls
      const houseGroup = new THREE.Group();

      const wall1 = new THREE.Mesh(new THREE.BoxGeometry(8, 3, 0.3), wallMat);
      wall1.position.set(0, 1.5, -4);
      const wall2 = new THREE.Mesh(new THREE.BoxGeometry(0.3, 3, 8), wallMat);
      wall2.position.set(-4, 1.5, 0);
      const wall3 = new THREE.Mesh(new THREE.BoxGeometry(8, 3, 0.3), wallMat);
      wall3.position.set(0, 1.5, 4);
      const wall4 = new THREE.Mesh(new THREE.BoxGeometry(0.3, 3, 8), wallMat);
      wall4.position.set(4, 1.5, 0);

      const window1 = new THREE.Mesh(new THREE.BoxGeometry(2, 1, 0.3), windowMat);
      window1.position.set(0, 1.5, -4);

      houseGroup.add(wall1, wall2, wall3, wall4, window1);
      houseGroup.position.set(x, 0, z);
      scene.add(houseGroup);
      obstacles.push(houseGroup);
    }
  }

  function spawnEnemy() {
    const enemyMat = new THREE.MeshStandardMaterial({ color: 0xff3333 });
    const enemy = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), enemyMat);
    enemy.position.set(Math.random() * 100 - 50, 1, Math.random() * 100 - 50);
    enemy.health = 100;
    scene.add(enemy);
    enemies.push(enemy);
  }

  function shoot() {
    raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
    const intersects = raycaster.intersectObjects(enemies);
    if (intersects.length > 0) {
      const enemy = intersects[0].object;
      enemy.health -= 50;
      if (enemy.health <= 0) {
        scene.remove(enemy);
        enemies = enemies.filter(e => e !== enemy);
        setTimeout(spawnEnemy, 2000);
      }
    }
  }

  function enemyShoot(enemy) {
    const dir = new THREE.Vector3().subVectors(camera.position, enemy.position).normalize();
    const dist = enemy.position.distanceTo(camera.position);
    if (dist < 50 && Math.random() < 0.01) {
      health -= 5;
      if (health <= 0) {
        alert("You died!");
        location.reload();
      }
    }
  }

  function animate() {
    requestAnimationFrame(animate);
    const delta = clock.getDelta();

    // Movement
    velocity.set(0, 0, 0);
    const speed = 10 * delta;
    if (move.forward) controls.moveForward(speed);
    if (move.back) controls.moveForward(-speed);
    if (move.left) controls.moveRight(-speed);
    if (move.right) controls.moveRight(speed);

    // Enemies move toward player
    enemies.forEach(enemy => {
      const dir = new THREE.Vector3().subVectors(camera.position, enemy.position);
      if (dir.length() > 2) {
        dir.normalize().multiplyScalar(0.5 * delta);
        enemy.position.add(dir);
      }
      enemyShoot(enemy);
    });

    renderer.render(scene, camera);
  }
</script>
</body>
</html>
